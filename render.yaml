services:
  - type: web
    name: retail-data-service
    env: python
    buildCommand: |
      pip install -r requirements.txt
      echo "Setting up data files for deployment..."
      # Ensure data-docs directory exists
      mkdir -p data-docs
      # Copy existing data files from repository if they exist
      if [ -f "data-docs/mock_data.xlsx" ]; then
        echo "✅ Found mock_data.xlsx in repository"
      else
        echo "⚠️  mock_data.xlsx not found, creating sample data..."
        # Create fallback data files
        cat > data-docs/data.json << 'EOF'
        {
          "employees": [
            {"id": 1, "name": "John Doe", "department": "IT", "salary": 75000, "email": "john.doe@company.com"},
            {"id": 2, "name": "Jane Smith", "department": "HR", "salary": 65000, "email": "jane.smith@company.com"},
            {"id": 3, "name": "Bob Johnson", "department": "Sales", "salary": 70000, "email": "bob.johnson@company.com"}
          ],
          "departments": [
            {"id": 1, "name": "IT", "location": "Floor 1", "manager": "John Doe"},
            {"id": 2, "name": "HR", "location": "Floor 2", "manager": "Jane Smith"},
            {"id": 3, "name": "Sales", "location": "Floor 3", "manager": "Bob Johnson"}
          ]
        }
        EOF
        cat > data-docs/data.csv << 'EOF'
        id,name,department,salary,email
        1,John Doe,IT,75000,john.doe@company.com
        2,Jane Smith,HR,65000,jane.smith@company.com
        3,Bob Johnson,Sales,70000,bob.johnson@company.com
        EOF
      fi
      # List all data files
      echo "📁 Data files in data-docs directory:"
      ls -la data-docs/
      echo ""
      echo "📊 File sizes:"
      du -h data-docs/*
      echo ""
      echo "✅ Data files ready for deployment"
    startCommand: uvicorn app.main:app --host 0.0.0.0 --port $PORT
    envVars:
      - key: DATA_DIR
        value: data-docs
      - key: ENABLE_CORS
        value: true
      - key: PYTHON_VERSION
        value: 3.11.0
      - key: WATCH_FILE
        value: false
    healthCheckPath: /health
    autoDeploy: true
    branch: main 