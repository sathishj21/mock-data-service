services:
  - type: web
    name: retail-data-service
    env: python
    buildCommand: |
      pip install -r requirements.txt
      echo "Setting up data files for deployment..."
      
      # Debug: Show current directory and contents
      echo "Current directory: $(pwd)"
      echo "Repository contents:"
      ls -la
      
      # Create data-docs directory in the correct location for runtime
      mkdir -p /app/data-docs
      echo "Created data-docs directory at: /app/data-docs"
      
      # ALWAYS create data files in the runtime location
      echo "Creating data files for deployment..."
      
      # Create comprehensive sample data files in /app/data-docs
      cat > /app/data-docs/data.json << 'EOF'
      {
        "employees": [
          {"id": 1, "name": "John Doe", "department": "IT", "salary": 75000, "email": "john.doe@company.com"},
          {"id": 2, "name": "Jane Smith", "department": "HR", "salary": 65000, "email": "jane.smith@company.com"},
          {"id": 3, "name": "Bob Johnson", "department": "Sales", "salary": 70000, "email": "bob.johnson@company.com"},
          {"id": 4, "name": "Alice Brown", "department": "Marketing", "salary": 68000, "email": "alice.brown@company.com"},
          {"id": 5, "name": "Charlie Wilson", "department": "IT", "salary": 72000, "email": "charlie.wilson@company.com"}
        ],
        "departments": [
          {"id": 1, "name": "IT", "location": "Floor 1", "manager": "John Doe"},
          {"id": 2, "name": "HR", "location": "Floor 2", "manager": "Jane Smith"},
          {"id": 3, "name": "Sales", "location": "Floor 3", "manager": "Bob Johnson"},
          {"id": 4, "name": "Marketing", "location": "Floor 4", "manager": "Alice Brown"}
        ],
        "products": [
          {"id": 1, "name": "Laptop", "category": "Electronics", "price": 999.99, "stock": 50},
          {"id": 2, "name": "Mouse", "category": "Electronics", "price": 29.99, "stock": 100},
          {"id": 3, "name": "Keyboard", "category": "Electronics", "price": 79.99, "stock": 75},
          {"id": 4, "name": "Monitor", "category": "Electronics", "price": 299.99, "stock": 25}
        ]
      }
      EOF
      
      cat > /app/data-docs/data.csv << 'EOF'
      id,name,department,salary,email
      1,John Doe,IT,75000,john.doe@company.com
      2,Jane Smith,HR,65000,jane.smith@company.com
      3,Bob Johnson,Sales,70000,bob.johnson@company.com
      4,Alice Brown,Marketing,68000,alice.brown@company.com
      5,Charlie Wilson,IT,72000,charlie.wilson@company.com
      EOF
      
      cat > /app/data-docs/products.csv << 'EOF'
      id,name,category,price,stock
      1,Laptop,Electronics,999.99,50
      2,Mouse,Electronics,29.99,100
      3,Keyboard,Electronics,79.99,75
      4,Monitor,Electronics,299.99,25
      5,Headphones,Electronics,149.99,30
      EOF
      
      cat > /app/data-docs/sample_data.csv << 'EOF'
      id,name,department,salary,email
      1,John Doe,IT,75000,john.doe@company.com
      2,Jane Smith,HR,65000,jane.smith@company.com
      3,Bob Johnson,Sales,70000,bob.johnson@company.com
      4,Alice Brown,Marketing,68000,alice.brown@company.com
      5,Charlie Wilson,IT,72000,charlie.wilson@company.com
      EOF
      
      echo "âœ… Sample data files created in /app/data-docs"
      
      # List all data files
      echo "ðŸ“ Data files in /app/data-docs directory:"
      ls -la /app/data-docs/
      echo ""
      echo "ðŸ“Š File sizes:"
      du -h /app/data-docs/*
      echo ""
      echo "ðŸ” Absolute path of data-docs:"
      echo "/app/data-docs"
      echo ""
      echo "âœ… Data files ready for deployment"
    startCommand: |
      echo "Starting application..."
      echo "Current directory: $(pwd)"
      echo "Checking /app/data-docs directory:"
      ls -la /app/data-docs/ || echo "/app/data-docs directory not found"
      echo "Starting uvicorn..."
      uvicorn app.main:app --host 0.0.0.0 --port $PORT
    envVars:
      - key: DATA_DIR
        value: /app/data-docs
      - key: ENABLE_CORS
        value: true
      - key: PYTHON_VERSION
        value: 3.11.0
      - key: WATCH_FILE
        value: false
    healthCheckPath: /health
    autoDeploy: true
    branch: main 